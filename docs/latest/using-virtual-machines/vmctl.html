<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>KubeVirt Latest | Using Virtual Machines | vmctl</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <link href="../../latest/_stylesheets/asciibinder.css" rel="stylesheet" />

   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
   <!--[if lt IE 9]>
     <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
     <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->

  <link href="../../latest/_images/favicon32x32.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="../../latest/_images/favicon.ico"><![endif]-->
  <meta content="AsciiBinder" name="application-name">
</head>
<body>
  <div class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="http://www.asciibinder.org/"><img alt="AsciiBinder" height="64px" src="../../latest/_images/KubeVirt_icon.png"></a>
      </div>
    </div>
  </div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../index.html">Documentation</a>
      </li>
      <li class="hidden-xs active">
        <a href="../welcome/index.html">KubeVirt Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../using-virtual-machines/usage.html">Using Virtual Machines</a>
      </li>
      
      <li class="hidden-xs active">
        vmctl
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-right"></span>Welcome
      </a>
      <ul id="topicGroup0" class="collapse  list-unstyled">
            <li><a class="" href="../welcome/index.html">Welcome</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup1">
        <span id="tgSpan1" class="fa fa-angle-right"></span>Release Notes
      </a>
      <ul id="topicGroup1" class="collapse  list-unstyled">
            <li><a class="" href="../release-notes/changelog.html">Changelog</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup2">
        <span id="tgSpan2" class="fa fa-angle-right"></span>Architecture
      </a>
      <ul id="topicGroup2" class="collapse  list-unstyled">
            <li><a class="" href="../architecture/virtual-machine.html">Virtual Machines</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup3">
        <span id="tgSpan3" class="fa fa-angle-right"></span>Installation & Administration
      </a>
      <ul id="topicGroup3" class="collapse  list-unstyled">
            <li><a class="" href="../administration/intro.html">Installation</a></li>
            <li><a class="" href="../administration/api-validation.html">Webhooks</a></li>
            <li><a class="" href="../administration/authorization.html">Authorization</a></li>
            <li><a class="" href="../administration/monitoring.html">Monitoring</a></li>
            <li><a class="" href="../administration/annotations_and_labels.html">Annotations and Labels</a></li>
            <li><a class="" href="../administration/unresponsive-nodes.html">Unresponsive node handling</a></li>
            <li><a class="" href="../administration/node-eviction.html">Node eviciton</a></li>
            <li><a class="" href="../administration/image-upload.html">Image upload</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup4">
        <span id="tgSpan4" class="fa fa-angle-right"></span>Creating Virtual Machines
      </a>
      <ul id="topicGroup4" class="collapse  list-unstyled">
            <li><a class="" href="../creating-virtual-machines/intro.html">Introduction</a></li>
            <li><a class="" href="../creating-virtual-machines/virtualized-hardware-configuration.html">Devices</a></li>
            <li><a class="" href="../creating-virtual-machines/disks-and-volumes.html">Disks and Volumes</a></li>
            <li><a class="" href="../creating-virtual-machines/interfaces-and-networks.html">Interfaces and Networks</a></li>
            <li><a class="" href="../creating-virtual-machines/dedicated-cpu.html">Guaranteed CPU usage</a></li>
            <li><a class="" href="../creating-virtual-machines/startup-scripts.html">cloud-init</a></li>
            <li><a class="" href="../creating-virtual-machines/guest-operating-system-information.html">Associating Guest Informations</a></li>
            <li><a class="" href="../creating-virtual-machines/presets.html">Presets</a></li>
            <li><a class="" href="../creating-virtual-machines/probes.html">Probes</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup5">
        <span id="tgSpan5" class="fa fa-angle-down"></span>Using Virtual Machines
      </a>
      <ul id="topicGroup5" class="collapse in list-unstyled">
            <li><a class="" href="../using-virtual-machines/usage.html">Usage</a></li>
            <li><a class="" href="../using-virtual-machines/life-cycle.html">Starting and Stopping</a></li>
            <li><a class="" href="../using-virtual-machines/graphical-and-console-access.html">Console Access (Serial and Graphical)</a></li>
            <li><a class="" href="../using-virtual-machines/assigning-vms-to-nodes.html">Node placement</a></li>
            <li><a class="" href="../using-virtual-machines/dns.html">DNS Integration</a></li>
            <li><a class="" href="../using-virtual-machines/expose-service.html">Service Integration</a></li>
            <li><a class="" href="../using-virtual-machines/create-networkpolicy.html">Assigning Network Policies</a></li>
            <li><a class="" href="../using-virtual-machines/overcommit.html">Memory over-commit</a></li>
            <li><a class="" href="../using-virtual-machines/virtual-machine-replica-set.html">Virtual Machine Replica Set</a></li>
            <li><a class=" active" href="../using-virtual-machines/vmctl.html">vmctl</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup6">
        <span id="tgSpan6" class="fa fa-angle-right"></span>Working with Templates
      </a>
      <ul id="topicGroup6" class="collapse  list-unstyled">
            <li><a class="" href="../templates/common-templates.html">Introduction</a></li>
            <li><a class="" href="../templates/using-templates.html">Using templates</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>VMCTL</h2>
        </div>
        <div class="sect1">
<h2 id="vmctl"><a class="anchor" href="#vmctl"></a>VMCTL</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="background"><a class="anchor" href="#background"></a>Background</h3>
<div class="paragraph">
<p>One remarkable difference between KubeVirt and other solutions that run
Virtual Machine workloads in a container is the toplevel API. KubeVirt
treats VirtualMachineInstances as a first class citizen by designating
custom resources to map/track VirtualMachine settings and attributes.
This has considerable advantages, but there’s a trade-off: native
Kubernetes higher-level workload controllers such as Deployments,
ReplicaSets, DaemonSets, StatefulSets are designed to work directly with
Pods. Because VirtualMachine and VirtualMachineInstance resources are
simply defined outside the scope of Kubernetes responsibility, it will
always be up to the KubeVirt project to create analogues of those
controllers. This is possible, and is in fact something that exists for
some entities, e.g. VirtualMachineInstanceReplicaSet, but the KubeVirt
project will always be one step behind. Any significant changes upstream
would need to be implemented manually in KubeVirt.</p>
</div>
</div>
<div class="sect2">
<h3 id="overview"><a class="anchor" href="#overview"></a>Overview</h3>
<div class="paragraph">
<p>Vmctl is designed to address this delta by managing VirtualMachines from
within a Pod. Vmctl will take an upstream VirtualMachine to act as a
prototype and derive and spawn a new VirtualMachine based on it. This
derived VM will be running alongside the vmctl pod. Thus for every vmctl
pod in the cluster, there should be a VM running alongside of it. To be
clear, vmctl is not a VM instead it is controlling a VM close by. The
derived VM will be similar to the prototype, but a few fields will be
modified:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Name</p>
</li>
<li>
<p>NodeSelector</p>
</li>
<li>
<p>Running</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="name"><a class="anchor" href="#name"></a>Name</h4>
<div class="paragraph">
<p>The new VirtualMachine’s <code>Name</code> attribute will be a concatenation of the
prototype VM’s name and the Pod’s name. This will be a unique resource
name because both the prototype VM name and the vmctl Pod name are
unique.</p>
</div>
</div>
<div class="sect3">
<h4 id="nodeselector"><a class="anchor" href="#nodeselector"></a>NodeSelector</h4>
<div class="paragraph">
<p>The new VirtualMachine will have a selector with node affinity matching
the running vmctl Pod’s node, thus the VirtualMachine and the vmctl Pod
will run on the same node. This is because a <code>DaemonSet</code> maps one pod to
each node in a cluster. By tracking which Node a vmctl Pod is running
on, KubeVirt ensures the same behavior for VirtualMachines.</p>
</div>
</div>
<div class="sect3">
<h4 id="running"><a class="anchor" href="#running"></a>Running</h4>
<div class="paragraph">
<p>The new VirtualMachine will be set to the running state regardless of
the prototype VM’s state.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="implementation"><a class="anchor" href="#implementation"></a>Implementation</h3>
<div class="paragraph">
<p>Vmctl is implemented as a go binary, deployed in a container, that takes
the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>namespace</code>: The namespace to create the derived VirtualMachine in.
The default namespace is <code>default</code>.</p>
</li>
<li>
<p><code>proto-namespace</code>: The namespace the prototype VM is in. This defaults
to the value used for <code>namespace</code> if omitted.</p>
</li>
<li>
<p><code>hostname-override</code>: Mainly for testing–in order to make it possible
to run vmctl outside of a pod.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>vmctl has a single positional argument:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>prototype VM name</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the vmctl container is deployed, it will locate the requested
prototype VM, clone it, and watch wait. When the vmctl pod is deleted,
vmctl will clean up the derived VirtualMachine. Consequently it is
inadvisable to use a 0 length grace period for shutting down the pod.</p>
</div>
</div>
<div class="sect2">
<h3 id="services"><a class="anchor" href="#services"></a>Services</h3>
<div class="paragraph">
<p>One note worth stressing is that from Kubernete’s perspective the vmctl
Pod is entirely distinct from the VM it spawns. It is especially
important to be mindful of this when creating services. From an end
user’s perspective, there’s nothing useful running on the vmctl Pod
itself. The recommended method of exposing services on a VM is to use
Labels and Selectors. Applying a label to the prototype VM, and using
that <code>matchLabel</code> on a service is sufficient to expose the service on
all derived VM’s.</p>
</div>
</div>
<div class="sect2">
<h3 id="persistentvolumeclaims"><a class="anchor" href="#persistentvolumeclaims"></a>PersistentVolumeClaims</h3>
<div class="paragraph">
<p>Another thing to consider with vmctl is the use of shared volumes. By
nature vmctl is designed to spawn an arbitrary number of VirtualMachines
on demand, all of which will define the same Disk and Volume stanzas.
Because of this, using shared volumes in read-write mode should be
avoided, or the PVC’s could be corrupted. To avoid this issue, ephemeral
disks or ContainerDisks could be used.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following PodPreset applies to all examples below. This is done to
remove lines that are related to the Kubernetes DownwardAPI in order to
make the examples more clear.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">settings.k8s.io/v1alpha1</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">PodPreset</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">have-podinfo</span></span>
  <span style="color:#606">selector</span>:
    <span style="color:#606">matchLabels</span>:
      <span style="color:#606">app</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">vmctl</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">volumeMounts</span>:
    - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: podinfo</span></span>
      <span style="color:#606">mountPath</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">/etc/podinfo</span></span>
  <span style="color:#606">volumes</span>:
    - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: podinfo</span></span>
      <span style="color:#606">downwardAPI</span>:
        <span style="color:#606">items</span>:
        - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">path: &quot;name&quot;</span></span>
          <span style="color:#606">fieldRef</span>:
            <span style="color:#606">fieldPath</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">metadata.name</span></span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="deployment"><a class="anchor" href="#deployment"></a>Deployment</h3>
<div class="paragraph">
<p>This is an example of using vmctl as a Deployment (Note: this example
uses the <code>have-podinfo</code> PodPreset above):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">apps/v1</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">Deployment</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">vmctl</span></span>
  <span style="color:#606">labels</span>:
    <span style="color:#606">app</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">vmctl</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">replicas</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">3</span></span>
  <span style="color:#606">selector</span>:
    <span style="color:#606">matchLabels</span>:
      <span style="color:#606">app</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">vmctl</span></span>
  <span style="color:#606">template</span>:
    <span style="color:#606">metadata</span>:
      <span style="color:#606">labels</span>:
        <span style="color:#606">app</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">vmctl</span></span>
    <span style="color:#606">spec</span>:
      <span style="color:#606">containers</span>:
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: vmctl</span></span>
        <span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">quay.io/fabiand/vmctl</span></span>
        <span style="color:#606">imagePullPolicy</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">IfNotPresent</span></span>
        <span style="color:#606">args</span>:
        - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">testvm</span><span style="color:#710">&quot;</span></span>
        <span style="color:#606">serviceAccountName</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">default</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example would look for a VirtualMachine in the <code>default</code> namespace
named <code>testvm</code>, and instantiate 3 replicas of it.</p>
</div>
</div>
<div class="sect2">
<h3 id="daemonset"><a class="anchor" href="#daemonset"></a>Daemonset</h3>
<div class="paragraph">
<p>This is an example of using vmctl as a Daemonset (Note: this example
uses the <code>have-podinfo</code> PodPreset above):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">apps/v1</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">Daemonset</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">vmctl</span></span>
  <span style="color:#606">labels</span>:
    <span style="color:#606">app</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">vmctl</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">selector</span>:
    <span style="color:#606">matchLabels</span>:
      <span style="color:#606">app</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">vmctl</span></span>
  <span style="color:#606">template</span>:
    <span style="color:#606">metadata</span>:
      <span style="color:#606">labels</span>:
        <span style="color:#606">app</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">vmctl</span></span>
    <span style="color:#606">spec</span>:
      <span style="color:#606">containers</span>:
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: vmctl</span></span>
        <span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">quay.io/fabiand/vmctl</span></span>
        <span style="color:#606">imagePullPolicy</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">IfNotPresent</span></span>
        <span style="color:#606">args</span>:
        - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">testvm</span><span style="color:#710">&quot;</span></span>
        <span style="color:#606">serviceAccountName</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">default</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example would look for a VirtualMachine in the <code>default</code> namespace
named <code>testvm</code>, and instantiate a VirtualMachine on every node in the
Kubernetes cluster.</p>
</div>
</div>
<div class="sect2">
<h3 id="service"><a class="anchor" href="#service"></a>Service</h3>
<div class="paragraph">
<p>Assuming a controller similar to the examples above, where a label
<code>app: vmctl</code> is used, a service to expose the VM’s could look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">Service</span></span>
<span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">v1</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">my-service</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">selector</span>:
    <span style="color:#606">app</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">vmctl</span></span>
  <span style="color:#606">ports</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">protocol: TCP</span></span>
    <span style="color:#606">port</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">80</span></span>
    <span style="color:#606">targetPort</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">80</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case a clusterIP would be created that maps port 80 to each VM.
See
<a href="https://kubernetes.io/docs/concepts/services-networking/service/">Kubernetes
Services</a> for more information.</p>
</div>
</div>
</div>
</div>
      </div>
    </div>
  </div>
   <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
   <!-- Latest compiled and minified JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <script src="../../latest/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
   <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
</body>
</html>
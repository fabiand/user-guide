<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>KubeVirt Latest | Creating Virtual Machines | cloud-init</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <link href="../../latest/_stylesheets/asciibinder.css" rel="stylesheet" />

   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
   <!--[if lt IE 9]>
     <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
     <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->

  <link href="../../latest/_images/favicon32x32.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="../../latest/_images/favicon.ico"><![endif]-->
  <meta content="AsciiBinder" name="application-name">
</head>
<body>
  <div class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="http://www.asciibinder.org/"><img alt="AsciiBinder" height="64px" src="../../latest/_images/KubeVirt_icon.png"></a>
      </div>
    </div>
  </div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../index.html">Documentation</a>
      </li>
      <li class="hidden-xs active">
        <a href="../welcome/index.html">KubeVirt Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../creating-virtual-machines/intro.html">Creating Virtual Machines</a>
      </li>
      
      <li class="hidden-xs active">
        cloud-init
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-right"></span>Welcome
      </a>
      <ul id="topicGroup0" class="collapse  list-unstyled">
            <li><a class="" href="../welcome/index.html">Welcome</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup1">
        <span id="tgSpan1" class="fa fa-angle-right"></span>Release Notes
      </a>
      <ul id="topicGroup1" class="collapse  list-unstyled">
            <li><a class="" href="../release-notes/changelog.html">Changelog</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup2">
        <span id="tgSpan2" class="fa fa-angle-right"></span>Architecture
      </a>
      <ul id="topicGroup2" class="collapse  list-unstyled">
            <li><a class="" href="../architecture/virtual-machine.html">Virtual Machines</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup3">
        <span id="tgSpan3" class="fa fa-angle-right"></span>Installation & Administration
      </a>
      <ul id="topicGroup3" class="collapse  list-unstyled">
            <li><a class="" href="../administration/intro.html">Installation</a></li>
            <li><a class="" href="../administration/api-validation.html">Webhooks</a></li>
            <li><a class="" href="../administration/authorization.html">Authorization</a></li>
            <li><a class="" href="../administration/monitoring.html">Monitoring</a></li>
            <li><a class="" href="../administration/annotations_and_labels.html">Annotations and Labels</a></li>
            <li><a class="" href="../administration/unresponsive-nodes.html">Unresponsive node handling</a></li>
            <li><a class="" href="../administration/node-eviction.html">Node eviciton</a></li>
            <li><a class="" href="../administration/image-upload.html">Image upload</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup4">
        <span id="tgSpan4" class="fa fa-angle-down"></span>Creating Virtual Machines
      </a>
      <ul id="topicGroup4" class="collapse in list-unstyled">
            <li><a class="" href="../creating-virtual-machines/intro.html">Introduction</a></li>
            <li><a class="" href="../creating-virtual-machines/virtualized-hardware-configuration.html">Devices</a></li>
            <li><a class="" href="../creating-virtual-machines/disks-and-volumes.html">Disks and Volumes</a></li>
            <li><a class="" href="../creating-virtual-machines/interfaces-and-networks.html">Interfaces and Networks</a></li>
            <li><a class="" href="../creating-virtual-machines/dedicated-cpu.html">Guaranteed CPU usage</a></li>
            <li><a class=" active" href="../creating-virtual-machines/startup-scripts.html">cloud-init</a></li>
            <li><a class="" href="../creating-virtual-machines/guest-operating-system-information.html">Associating Guest Informations</a></li>
            <li><a class="" href="../creating-virtual-machines/presets.html">Presets</a></li>
            <li><a class="" href="../creating-virtual-machines/probes.html">Probes</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup5">
        <span id="tgSpan5" class="fa fa-angle-right"></span>Using Virtual Machines
      </a>
      <ul id="topicGroup5" class="collapse  list-unstyled">
            <li><a class="" href="../using-virtual-machines/usage.html">Usage</a></li>
            <li><a class="" href="../using-virtual-machines/life-cycle.html">Starting and Stopping</a></li>
            <li><a class="" href="../using-virtual-machines/graphical-and-console-access.html">Console Access (Serial and Graphical)</a></li>
            <li><a class="" href="../using-virtual-machines/assigning-vms-to-nodes.html">Node placement</a></li>
            <li><a class="" href="../using-virtual-machines/dns.html">DNS Integration</a></li>
            <li><a class="" href="../using-virtual-machines/expose-service.html">Service Integration</a></li>
            <li><a class="" href="../using-virtual-machines/create-networkpolicy.html">Assigning Network Policies</a></li>
            <li><a class="" href="../using-virtual-machines/overcommit.html">Memory over-commit</a></li>
            <li><a class="" href="../using-virtual-machines/virtual-machine-replica-set.html">Virtual Machine Replica Set</a></li>
            <li><a class="" href="../using-virtual-machines/vmctl.html">vmctl</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup6">
        <span id="tgSpan6" class="fa fa-angle-right"></span>Working with Templates
      </a>
      <ul id="topicGroup6" class="collapse  list-unstyled">
            <li><a class="" href="../templates/common-templates.html">Introduction</a></li>
            <li><a class="" href="../templates/using-templates.html">Using templates</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>Startup Scripts</h2>
        </div>
        <div class="sect1">
<h2 id="startup-scripts"><a class="anchor" href="#startup-scripts"></a>Startup Scripts</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="overview"><a class="anchor" href="#overview"></a>Overview</h3>
<div class="paragraph">
<p>KubeVirt supports the ability to assign a startup script to a
VirtualMachineInstance instance which is executed automatically when the
VM initializes.</p>
</div>
<div class="paragraph">
<p>These scripts are commonly used to automate injection of users and SSH
keys into VMs in order to provide remote access to the machine. For
example, a startup script can be used to inject credentials into a VM
that allows an Ansible job running on a remote host to access and
provision the VM.</p>
</div>
<div class="paragraph">
<p>Startup scripts are not limited to any specific use case though. They
can be used to run any arbitrary script in a VM on boot.</p>
</div>
<div class="sect3">
<h4 id="cloud-init"><a class="anchor" href="#cloud-init"></a>Cloud-init</h4>
<div class="paragraph">
<p>cloud-init is a widely adopted project used for early initialization of
a VM. Used by cloud providers such as AWS and GCP, cloud-init has
established itself as the defacto method of providing startup scripts to
VMs.</p>
</div>
<div class="paragraph">
<p>Cloud-init documentation can be found here:
<a href="https://cloudinit.readthedocs.io/en/latest/">Cloud-init Documentation</a>.</p>
</div>
<div class="paragraph">
<p>KubeVirt supports cloud-initâ€™s ``NoCloud'' datasource which involves
injecting startup scripts into a VM instance though the use of an
ephemeral disk. VMs with the cloud-init package installed will detect
the ephemeral disk and execute custom userdata scripts at boot.</p>
</div>
</div>
<div class="sect3">
<h4 id="sysprep"><a class="anchor" href="#sysprep"></a>Sysprep</h4>
<div class="paragraph">
<p>Sysprep is an automation tool for Windows that automates Windows
installation, setup, and custom software provisioning.</p>
</div>
<div class="paragraph">
<p><strong>Sysprep support is currently not implemented by KubeVirt.</strong> However it
is a feature the KubeVirt upstream community has shown interest in. As a
result, it is likely Sysprep support will make its way into a future
KubeVirt release.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cloud-init-examples"><a class="anchor" href="#cloud-init-examples"></a>Cloud-init Examples</h3>
<div class="paragraph">
<p>KubeVirt supports the cloud-init NoCloud datasource which involves
injecting startup scripts through the use of a disk attached to the VM.</p>
</div>
<div class="paragraph">
<p>In order to assign a custom userdata script to a VirtualMachineInstance
using this method, users must define a disk and a volume for the NoCloud
datasource in the VirtualMachineInstanceâ€™s spec.</p>
</div>
<div class="sect3">
<h4 id="cloud-init-user-data-as-clear-text"><a class="anchor" href="#cloud-init-user-data-as-clear-text"></a>Cloud-init user-data as clear text</h4>
<div class="paragraph">
<p>In the example below, a SSH key is stored in the cloudInitNoCloud
Volumeâ€™s userData field as clean text. There is a corresponding disks
entry that references the cloud-init volume and assigns it to the VMâ€™s
device.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># Create a VM manifest with the startup script
# a cloudInitNoCloud volume's userData field.

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha2
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        volumeName: registryvolume
        disk:
          bus: virtio
      - name: cloudinitdisk
        volumeName: cloudinitvolume
        disk:
          bus: virtio
  volumes:
    - name: registryvolume
      containerDisk:
        image: kubevirt/cirros-container-disk-demo:latest
    - name: cloudinitvolume
      cloudInitNoCloud:
        userData: |
          ssh-authorized-keys:
            - ssh-rsa AAAAB3NzaK8L93bWxnyp test@test.com

END

# Post the Virtual Machine spec to KubeVirt.

kubectl create -f my-vmi.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cloud-init-user-data-as-base64-string"><a class="anchor" href="#cloud-init-user-data-as-base64-string"></a>Cloud-init user-data as base64 string</h4>
<div class="paragraph">
<p>In the example below, a simple bash script is base64 encoded and stored
in the cloudInitNoCloud Volumeâ€™s userDataBase64 field. There is a
corresponding disks entry that references the cloud-init volume and
assigns it to the VMâ€™s device.</p>
</div>
<div class="paragraph">
<p><em>Users also have the option of storing the startup script in a
Kubernetes Secret and referencing the Secret in the VMâ€™s spec. Examples
further down in the document illustrate how that is done.</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># Create a simple startup script

cat &lt;&lt; END &gt; startup-script.sh
#!/bin/bash
echo &quot;Hi from startup script!&quot;
END

# Create a VM manifest with the startup script base64 encoded into
# a cloudInitNoCloud volume's userDataBase64 field.

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha2
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        volumeName: registryvolume
        disk:
          bus: virtio
      - name: cloudinitdisk
        volumeName: cloudinitvolume
        disk:
          bus: virtio
  volumes:
    - name: registryvolume
      containerDisk:
        image: kubevirt/cirros-container-disk-demo:latest
    - name: cloudinitvolume
      cloudInitNoCloud:
        userDataBase64: $(cat startup-script.sh | base64 -w0)
END

# Post the Virtual Machine spec to KubeVirt.

kubectl create -f my-vmi.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cloud-init-userdata-as-k8s-secret"><a class="anchor" href="#cloud-init-userdata-as-k8s-secret"></a>Cloud-init UserData as k8s Secret</h4>
<div class="paragraph">
<p>Users who wish to not store the cloud-init userdata directly in the
VirtualMachineInstance spec have the option to store the userdata into a
Kubernetes Secret and reference that Secret in the spec.</p>
</div>
<div class="paragraph">
<p>Multiple VirtualMachineInstance specs can reference the same Kubernetes
Secret containing cloud-init userdata.</p>
</div>
<div class="paragraph">
<p>Below is an example of how to create a Kubernetes Secret containing a
startup script and reference that Secret in the VMâ€™s spec.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># Create a simple startup script

cat &lt;&lt; END &gt; startup-script.sh
#!/bin/bash
echo &quot;Hi from startup script!&quot;
END

# Store the startup script in a Kubernetes Secret
kubectl create secret generic my-vmi-secret --from-file=userdata=startup-script.sh

# Create a VM manifest and reference the Secret's name in the cloudInitNoCloud
# Volume's secretRef field

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha2
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        volumeName: registryvolume
        disk:
          bus: virtio
      - name: cloudinitdisk
        volumeName: cloudinitvolume
        disk:
          bus: virtio
  volumes:
    - name: registryvolume
      containerDisk:
        image: kubevirt/cirros-registry-disk-demo:latest
    - name: cloudinitvolume
      cloudInitNoCloud:
        secretRef:
          name: my-vmi-secret
END

# Post the VM
kubectl create -f my-vmi.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="injecting-ssh-keys-with-cloud-init-s-cloud-config"><a class="anchor" href="#injecting-ssh-keys-with-cloud-init-s-cloud-config"></a>Injecting SSH keys with Cloud-initâ€™s Cloud-config</h4>
<div class="paragraph">
<p>In the examples so far, the cloud-init userdata script has been a bash
script. Cloud-init has itâ€™s own configuration that can handle some
common tasks such as user creation and SSH key injection.</p>
</div>
<div class="paragraph">
<p>More cloud-config examples can be found here:
<a href="https://cloudinit.readthedocs.io/en/latest/topics/examples.html">Cloud-init
Examples</a></p>
</div>
<div class="paragraph">
<p>Below is an example of using cloud-config to inject an SSH key for the
default user (fedora in this case) of a
<a href="https://getfedora.org/en/atomic/download/">Fedora Atomic</a> disk image.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># Create the cloud-init cloud-config userdata.
cat &lt;&lt; END &gt; startup-script
#cloud-config
password: atomic
chpasswd: { expire: False }
ssh_pwauth: False
ssh_authorized_keys:
    - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6zdgFiLr1uAK7PdcchDd+LseA5fEOcxCCt7TLlr7Mx6h8jUg+G+8L9JBNZuDzTZSF0dR7qwzdBBQjorAnZTmY3BhsKcFr8Gt4KMGrS6r3DNmGruP8GORvegdWZuXgASKVpXeI7nCIjRJwAaK1x+eGHwAWO9Z8ohcboHbLyffOoSZDSIuk2kRIc47+ENRjg0T6x2VRsqX27g6j4DfPKQZGk0zvXkZaYtr1e2tZgqTBWqZUloMJK8miQq6MktCKAS4VtPk0k7teQX57OGwD6D7uo4b+Cl8aYAAwhn0hc0C2USfbuVHgq88ESo2/+NwV4SQcl3sxCW21yGIjAGt4Hy7J fedora@localhost.localdomain
END

# Create the VM spec
cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha2
kind: VirtualMachineInstance
metadata:
  name: sshvmi
spec:
  terminationGracePeriodSeconds: 0
  domain:
    resources:
      requests:
        memory: 1024M
    devices:
      disks:
      - name: containerdisk
        volumeName: registryvolume
        disk:
          dev: vda
      - name: cloudinitdisk
        volumeName: cloudinitvolume
        disk:
          dev: vdb
  volumes:
    - name: registryvolume
      containerDisk:
        image: kubevirt/fedora-atomic-registry-disk-demo:latest
    - name: cloudinitvolume
      cloudInitNoCloud:
        userDataBase64: $(cat startup-script | base64 -w0)
END

# Post the VirtualMachineInstance spec to KubeVirt.
kubectl create -f my-vmi.yaml

# Connect to VM with passwordless SSH key
ssh -i &lt;insert private key here&gt; fedora@&lt;insert ip here&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="inject-ssh-key-using-a-custom-shell-script"><a class="anchor" href="#inject-ssh-key-using-a-custom-shell-script"></a>Inject SSH key using a Custom Shell Script</h4>
<div class="paragraph">
<p>Depending on the boot image in use, users may have a mixed experience
using cloud-initâ€™s cloud-config to create users and inject SSH keys.</p>
</div>
<div class="paragraph">
<p>Below is an example of creating a user and injecting SSH keys for that
user using a script instead of cloud-config.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cat &lt;&lt; END &gt; startup-script.sh
#!/bin/bash
export NEW_USER=&quot;foo&quot;
export SSH_PUB_KEY=&quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6zdgFiLr1uAK7PdcchDd+LseA5fEOcxCCt7TLlr7Mx6h8jUg+G+8L9JBNZuDzTZSF0dR7qwzdBBQjorAnZTmY3BhsKcFr8Gt4KMGrS6r3DNmGruP8GORvegdWZuXgASKVpXeI7nCIjRJwAaK1x+eGHwAWO9Z8ohcboHbLyffOoSZDSIuk2kRIc47+ENRjg0T6x2VRsqX27g6j4DfPKQZGk0zvXkZaYtr1e2tZgqTBWqZUloMJK8miQq6MktCKAS4VtPk0k7teQX57OGwD6D7uo4b+Cl8aYAAwhn0hc0C2USfbuVHgq88ESo2/+NwV4SQcl3sxCW21yGIjAGt4Hy7J $NEW_USER@localhost.localdomain&quot;

sudo adduser -U -m $NEW_USER
echo &quot;$NEW_USER:atomic&quot; | chpasswd
sudo mkdir /home/$NEW_USER/.ssh
sudo echo &quot;$SSH_PUB_KEY&quot; &gt; /home/$NEW_USER/.ssh/authorized_keys
sudo chown -R ${NEW_USER}: /home/$NEW_USER/.ssh
END

# Create the VM spec
cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha2
kind: VirtualMachineInstance
metadata:
  name: sshvmi
spec:
  terminationGracePeriodSeconds: 0
  domain:
    resources:
      requests:
        memory: 1024M
    devices:
      disks:
      - name: containerdisk
        volumeName: registryvolume
        disk:
          dev: vda
      - name: cloudinitdisk
        volumeName: cloudinitvolume
        disk:
          dev: vdb
  volumes:
    - name: registryvolume
      containerDisk:
        image: kubevirt/fedora-atomic-registry-disk-demo:latest
    - name: cloudinitvolume
      cloudInitNoCloud:
        userDataBase64: $(cat startup-script.sh | base64 -w0)
END

# Post the VirtualMachineInstance spec to KubeVirt.
kubectl create -f my-vmi.yaml

# Connect to VM with passwordless SSH key
ssh -i &lt;insert private key here&gt; foo@&lt;insert ip here&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="debugging"><a class="anchor" href="#debugging"></a>Debugging</h3>
<div class="paragraph">
<p>Depending on the operating system distribution in use, cloud-init output
is often printed to the console output on boot up. When developing
userdata scripts, users can connect to the VMâ€™s console during boot up
to debug.</p>
</div>
<div class="paragraph">
<p>Example of connecting to console using virtctl:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">virtctl console &lt;name of vmi&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
      </div>
    </div>
  </div>
   <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
   <!-- Latest compiled and minified JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <script src="../../latest/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
   <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
</body>
</html>